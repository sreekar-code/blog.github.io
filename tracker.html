<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow — Sreekar Scribbles</title>
    <script async src="https://analytics.balla.dev/script.js" data-website-id="2d661ca0-e926-4c3c-8d8c-e948998a7ac8"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="blogtitle">Sreekar Scribbles</header>
    <p><a href="index.html">Home</a> &nbsp;&nbsp; <a href="blog.html">Blog</a> &nbsp;&nbsp; Flow</p>
    <hr>

    <main class="tracker">

        <p class="streak-line">
            <strong id="currentStreak">0</strong> day flow
            <span class="streak-sep">·</span>
            best <strong id="bestStreak">0</strong>
            <span id="newRecord"></span>
        </p>

        <div class="dot-grid" id="grid"></div>

        <details class="log-section">
            <summary>log a post</summary>
            <div class="log-form">
                <input type="date" id="postDate">
                <button id="addPostBtn">add</button>
            </div>
            <ul class="log-list" id="postDatesList"></ul>
            <button id="resetBestBtn" class="reset-best">reset best</button>
        </details>

    </main>

    <hr>
    <footer class="site-footer">
        <a href="https://tally.so/r/w8eKr5">Subscribe</a><br>
        <a href="https://github.com/sreekar-code/blog.github.io.git">Source</a>
    </footer>

    <script>
        const DATES_KEY = 'blogPostDates';
        const BEST_KEY  = 'blogBestStreak';

        function getDates() {
            return JSON.parse(localStorage.getItem(DATES_KEY) || '[]');
        }
        function saveDates(dates) {
            localStorage.setItem(DATES_KEY, JSON.stringify([...new Set(dates)].sort()));
        }
        function getBest() {
            return parseInt(localStorage.getItem(BEST_KEY) || '0');
        }
        function saveBest(n) {
            localStorage.setItem(BEST_KEY, String(n));
        }

        function toYMD(d) {
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        // Convert a UTC millisecond timestamp to a local YYYY-MM-DD string.
        const DAY_MS = 86400000;
        function msToYMD(ms) {
            const d = new Date(ms);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }
        // Local midnight in ms — avoids date-object mutation bugs.
        function localMidnight() {
            const n = new Date();
            return new Date(n.getFullYear(), n.getMonth(), n.getDate()).getTime();
        }

        function calcStreak(dates) {
            if (!dates.length) return 0;
            const set = new Set(dates);
            const todayMs = localMidnight();
            // Grace period: streak is still alive if yesterday was posted.
            let startMs = todayMs;
            if (!set.has(msToYMD(startMs))) {
                startMs -= DAY_MS;
                if (!set.has(msToYMD(startMs))) return 0;
            }
            let count = 0;
            for (let t = startMs; set.has(msToYMD(t)); t -= DAY_MS) count++;
            return count;
        }

        // Always shows last 52 full weeks (364 days).
        // Ends on the Saturday of the current week so the grid is always full.
        function buildGrid() {
            const set = new Set(getDates());
            const today = new Date(); today.setHours(0,0,0,0);
            const todayStr = toYMD(today);

            // end = this Saturday, start = 363 days before (always a Sunday → 52×7 = 364 cells)
            const end = new Date(today);
            end.setDate(today.getDate() + (6 - today.getDay()));
            const start = new Date(end);
            start.setDate(end.getDate() - 363);

            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            const cur = new Date(start);
            while (cur <= end) {
                const ymd = toYMD(cur);
                const dot = document.createElement('div');
                dot.className = 'dot';
                if (cur > today)          dot.classList.add('dot-future');
                else if (set.has(ymd))    dot.classList.add('dot-filled');
                if (ymd === todayStr)     dot.classList.add('dot-today');
                dot.title = ymd;
                grid.appendChild(dot);
                cur.setDate(cur.getDate() + 1);
            }
        }

        function renderList(dates) {
            const list = document.getElementById('postDatesList');
            list.innerHTML = '';
            [...dates].sort().reverse().forEach(date => {
                const li  = document.createElement('li');
                const btn = document.createElement('button');
                btn.className = 'log-remove';
                btn.textContent = '×';
                btn.addEventListener('click', () => {
                    saveDates(getDates().filter(d => d !== date));
                    update();
                });
                li.appendChild(document.createTextNode(date));
                li.appendChild(btn);
                list.appendChild(li);
            });
        }

        function flashBest() {
            const el = document.getElementById('newRecord');
            el.textContent = ' new best!';
            el.className = '';
            void el.offsetWidth;
            el.className = 'flash-record';
        }

        function update() {
            const dates    = getDates();
            const streak   = calcStreak(dates);
            const prevBest = getBest();

            document.getElementById('currentStreak').textContent = streak;

            if (streak > prevBest) {
                saveBest(streak);
                document.getElementById('bestStreak').textContent = streak;
                if (prevBest > 0) flashBest();
            } else {
                document.getElementById('bestStreak').textContent = Math.max(prevBest, streak);
            }

            buildGrid();
            renderList(dates);
        }

        document.getElementById('addPostBtn').addEventListener('click', () => {
            const val = document.getElementById('postDate').value;
            if (!val) return;
            const dates = getDates();
            if (!dates.includes(val)) { dates.push(val); saveDates(dates); }
            update();
        });

        document.getElementById('postDate').addEventListener('keydown', e => {
            if (e.key === 'Enter') document.getElementById('addPostBtn').click();
        });

        // ── Admin password ──────────────────────────────────────────────────
        const ADMIN_PASS = 'sreekar'; // ← change this to whatever you like

        document.querySelector('.log-section > summary').addEventListener('click', e => {
            const panel = e.currentTarget.closest('details');
            if (panel.open) return; // closing is always allowed
            e.preventDefault();
            const input = prompt('password');
            if (input !== null && input === ADMIN_PASS) panel.open = true;
        });
        // ────────────────────────────────────────────────────────────────────

        document.getElementById('resetBestBtn').addEventListener('click', () => {
            if (confirm('Reset your best streak to 0?')) {
                saveBest(0);
                update();
            }
        });

        document.getElementById('postDate').value = toYMD(new Date());
        update();
    </script>
</body>
</html>
