<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow — Sreekar Scribbles</title>
    <script async src="https://analytics.balla.dev/script.js" data-website-id="2d661ca0-e926-4c3c-8d8c-e948998a7ac8"></script>
    <link rel="stylesheet" href="styles.css?v=3">
    <style>
        @keyframes flowShimmer {
            0%   { background-position: 200% center; }
            100% { background-position: -200% center; }
        }
        .stat-value {
            background: linear-gradient(
                90deg,
                var(--fg) 20%,
                var(--dot-today) 50%,
                var(--fg) 80%
            );
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: flowShimmer 6s linear infinite;
        }
    </style></head>
<body>
    <header class="blogtitle">Sreekar Scribbles</header>
    <p><a href="index.html">Home</a> &nbsp;&nbsp; <a href="blog.html">Blog</a> &nbsp;&nbsp; Flow &nbsp;&nbsp; <a href="cooking.html">Cooking</a></p>
    <hr>

    <main class="tracker">

        <div class="flow-stats">
            <div>
                <div class="stat-label">Flow</div>
                <div class="stat-value" id="streakCount">—</div>
            </div>
        </div>

        <div class="flow-calendar">
            <div class="cal-nav">
                <button id="prevMonth" class="cal-nav-btn">←</button>
                <span id="calTitle" class="cal-title"></span>
                <button id="nextMonth" class="cal-nav-btn">→</button>
            </div>
            <div class="cal-days-header">
                <span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span><span>S</span>
            </div>
            <div class="cal-grid" id="calGrid"></div>
        </div>

        <details class="log-section">
            <summary>Log post</summary>
            <div class="log-form">
                <input type="date" id="postDate">
                <button id="addPostBtn">add</button>
            </div>
            <p id="syncStatus" class="sync-status"></p>
            <ul class="log-list" id="postDatesList"></ul>
            <button id="changeTokenBtn" class="reset-best">change token</button>
        </details>

    </main>

    <hr>
    <footer class="site-footer">
        <a href="https://github.com/sreekar-code/blog.github.io.git">Source</a><br>
        <a href="feed.xml">RSS</a>
    </footer>

    <script>
        const TOKEN_KEY  = 'ghToken';
        const DATES_KEY  = 'blogPostDates';
        const GITHUB_API = 'https://api.github.com/repos/sreekar-code/blog.github.io/contents/dates.json';

        const MONTHS = ['January','February','March','April','May','June',
                        'July','August','September','October','November','December'];

        let dates = [];
        let viewYear  = new Date().getFullYear();
        let viewMonth = new Date().getMonth();

        function toYMD(d) {
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        function getWeekMonday(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            const dow = (d.getDay() + 6) % 7;
            d.setDate(d.getDate() - dow);
            return d;
        }

        function calcStreak() {
            if (!dates.length) return 0;
            const postSet = new Set(dates);

            function weekHasPost(monday) {
                for (let i = 0; i < 7; i++) {
                    const d = new Date(monday);
                    d.setDate(d.getDate() + i);
                    if (postSet.has(toYMD(d))) return true;
                }
                return false;
            }

            let monday = getWeekMonday(new Date());
            if (!weekHasPost(monday)) monday.setDate(monday.getDate() - 7);

            let streak = 0;
            while (weekHasPost(monday)) {
                streak++;
                monday.setDate(monday.getDate() - 7);
            }
            return streak;
        }

        function buildCalendar() {
            document.getElementById('calTitle').textContent = `${MONTHS[viewMonth]} ${viewYear}`;

            const grid = document.getElementById('calGrid');
            grid.innerHTML = '';

            const postSet   = new Set(dates);
            const today     = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr  = toYMD(today);
            const weekStart = getWeekMonday(today);
            const weekEnd   = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);

            const firstDay  = new Date(viewYear, viewMonth, 1);
            const startDow  = (firstDay.getDay() + 6) % 7;
            const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();

            for (let i = 0; i < startDow; i++) {
                const blank = document.createElement('div');
                blank.className = 'cal-cell cal-blank';
                grid.appendChild(blank);
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr  = `${viewYear}-${String(viewMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const cellDate = new Date(viewYear, viewMonth, d);

                const cell = document.createElement('div');
                cell.className = 'cal-cell';
                cell.textContent = d;

                if (postSet.has(dateStr)) {
                    cell.classList.add('cal-posted');
                } else if (dateStr === todayStr) {
                    cell.classList.add('cal-today');
                } else if (cellDate >= weekStart && cellDate <= weekEnd) {
                    cell.classList.add('cal-this-week');
                } else if (cellDate > today) {
                    cell.classList.add('cal-future');
                }

                grid.appendChild(cell);
            }
        }

        function updateStats() {
            const streak = calcStreak();
            document.getElementById('streakCount').textContent =
                streak === 1 ? '1 week' : `${streak} weeks`;
        }

        function update() {
            buildCalendar();
            updateStats();
            renderList();
        }

        document.getElementById('prevMonth').addEventListener('click', () => {
            viewMonth--;
            if (viewMonth < 0) { viewMonth = 11; viewYear--; }
            buildCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            viewMonth++;
            if (viewMonth > 11) { viewMonth = 0; viewYear++; }
            buildCalendar();
        });

        // ── GitHub sync ──────────────────────────────────────────────────────

        async function loadDates() {
            try {
                const res = await fetch('./dates.json?_=' + Date.now());
                if (!res.ok) throw new Error();
                dates = await res.json();
            } catch {
                dates = [];
            }
            const local = JSON.parse(localStorage.getItem(DATES_KEY) || '[]');
            dates = [...new Set([...dates, ...local])].sort();
        }

        function setSyncStatus(msg, isError) {
            const el = document.getElementById('syncStatus');
            if (!el) return;
            el.textContent = msg;
            el.style.color = isError ? '#c77' : '#aaa';
        }

        async function syncToGitHub() {
            dates = [...new Set(dates)].sort();
            localStorage.setItem(DATES_KEY, JSON.stringify(dates));
            const token = localStorage.getItem(TOKEN_KEY);
            if (!token) return;
            setSyncStatus('syncing…', false);
            try {
                const getRes = await fetch(GITHUB_API, {
                    headers: { Authorization: `Bearer ${token}`, 'X-GitHub-Api-Version': '2022-11-28' }
                });
                if (!getRes.ok) throw new Error('get failed');
                const { sha } = await getRes.json();
                const putRes = await fetch(GITHUB_API, {
                    method: 'PUT',
                    headers: {
                        Authorization: `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'X-GitHub-Api-Version': '2022-11-28'
                    },
                    body: JSON.stringify({
                        message: 'log: update post dates',
                        content: btoa(JSON.stringify(dates)),
                        sha
                    })
                });
                if (!putRes.ok) throw new Error('put failed');
                setSyncStatus('synced ✓', false);
                setTimeout(() => setSyncStatus('', false), 3000);
            } catch {
                setSyncStatus('sync failed — check token', true);
            }
        }

        // ── Admin panel ──────────────────────────────────────────────────────

        function renderList() {
            const list = document.getElementById('postDatesList');
            list.innerHTML = '';
            [...dates].sort().reverse().forEach(date => {
                const li  = document.createElement('li');
                const btn = document.createElement('button');
                btn.className = 'log-remove';
                btn.textContent = '×';
                btn.addEventListener('click', async () => {
                    dates = dates.filter(d => d !== date);
                    update();
                    await syncToGitHub();
                });
                li.appendChild(document.createTextNode(date));
                li.appendChild(btn);
                list.appendChild(li);
            });
        }

        document.getElementById('addPostBtn').addEventListener('click', async () => {
            const val = document.getElementById('postDate').value;
            if (!val) return;
            if (!dates.includes(val)) dates.push(val);
            update();
            await syncToGitHub();
        });

        document.getElementById('postDate').addEventListener('keydown', e => {
            if (e.key === 'Enter') document.getElementById('addPostBtn').click();
        });

        const ADMIN_HASH = '3b4b8072bd0a4606ffd2854d373d607aedb78a8406c929783c0b1db5cec80c25';

        async function hashInput(str) {
            const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
            return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        document.querySelector('.log-section > summary').addEventListener('click', e => {
            const panel = e.currentTarget.closest('details');
            if (panel.open) return;
            e.preventDefault();
            const input = prompt('password');
            if (input === null) return;
            hashInput(input).then(hash => {
                if (hash !== ADMIN_HASH) return;
                if (!localStorage.getItem(TOKEN_KEY)) {
                    const token = prompt('GitHub token (stored on this device only):');
                    if (token) localStorage.setItem(TOKEN_KEY, token.trim());
                }
                panel.open = true;
            });
        });

        document.getElementById('changeTokenBtn').addEventListener('click', () => {
            const token = prompt('Enter new GitHub token:');
            if (token === null) return;
            if (token.trim()) {
                localStorage.setItem(TOKEN_KEY, token.trim());
                setSyncStatus('token saved', false);
                setTimeout(() => setSyncStatus('', false), 2000);
            } else {
                localStorage.removeItem(TOKEN_KEY);
                setSyncStatus('token cleared', false);
                setTimeout(() => setSyncStatus('', false), 2000);
            }
        });

        document.getElementById('postDate').value = toYMD(new Date());
        loadDates().then(() => update());
    </script>
</body>
</html>
