<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow — Sreekar Scribbles</title>
    <script async src="https://analytics.balla.dev/script.js" data-website-id="2d661ca0-e926-4c3c-8d8c-e948998a7ac8"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="blogtitle">Sreekar Scribbles</header>
    <p><a href="index.html">Home</a> &nbsp;&nbsp; <a href="blog.html">Blog</a> &nbsp;&nbsp; Flow</p>
    <hr>

    <main class="tracker">

        <p class="streak-line">
            <strong id="currentStreak">0</strong> day flow
            <span class="streak-sep">·</span>
            best <strong id="bestStreak">0</strong>
        </p>

        <div class="dot-grid" id="grid"></div>

        <details class="log-section">
            <summary>log a post</summary>
            <div class="log-form">
                <input type="date" id="postDate">
                <button id="addPostBtn">add</button>
            </div>
            <p id="syncStatus" class="sync-status"></p>
            <ul class="log-list" id="postDatesList"></ul>
            <button id="changeTokenBtn" class="reset-best">change token</button>
        </details>

    </main>

    <hr>
    <footer class="site-footer">
        <a href="https://tally.so/r/w8eKr5">Subscribe</a><br>
        <a href="https://github.com/sreekar-code/blog.github.io.git">Source</a>
    </footer>

    <script>
        const TOKEN_KEY  = 'ghToken';
        const DATES_KEY  = 'blogPostDates';
        const GITHUB_API = 'https://api.github.com/repos/sreekar-code/blog.github.io/contents/dates.json';

        let dates = []; // in-memory source of truth

        async function loadDates() {
            // Read from the Pi's local dates.json (updated by git pull)
            try {
                const res = await fetch('./dates.json?_=' + Date.now());
                if (!res.ok) throw new Error();
                dates = await res.json();
            } catch {
                dates = [];
            }
            // Merge any locally-saved dates (fallback when GitHub sync hasn't run yet)
            const local = JSON.parse(localStorage.getItem(DATES_KEY) || '[]');
            dates = [...new Set([...dates, ...local])].sort();
        }

        function setSyncStatus(msg, isError) {
            const el = document.getElementById('syncStatus');
            if (!el) return;
            el.textContent = msg;
            el.style.color = isError ? '#c77' : '#aaa';
        }

        async function syncToGitHub() {
            dates = [...new Set(dates)].sort();
            // Always persist to localStorage so dates survive a page reload
            localStorage.setItem(DATES_KEY, JSON.stringify(dates));
            const token = localStorage.getItem(TOKEN_KEY);
            if (!token) return;
            setSyncStatus('syncing…', false);
            try {
                const getRes = await fetch(GITHUB_API, {
                    headers: { Authorization: `Bearer ${token}`, 'X-GitHub-Api-Version': '2022-11-28' }
                });
                if (!getRes.ok) throw new Error('get failed');
                const { sha } = await getRes.json();
                const putRes = await fetch(GITHUB_API, {
                    method: 'PUT',
                    headers: {
                        Authorization: `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'X-GitHub-Api-Version': '2022-11-28'
                    },
                    body: JSON.stringify({
                        message: 'log: update post dates',
                        content: btoa(JSON.stringify(dates)),
                        sha
                    })
                });
                if (!putRes.ok) throw new Error('put failed');
                setSyncStatus('synced ✓', false);
                setTimeout(() => setSyncStatus('', false), 3000);
            } catch {
                setSyncStatus('sync failed — check token', true);
            }
        }

        function calcBestStreak(arr) {
            if (!arr.length) return 0;
            const sorted = [...new Set(arr)].sort();
            let best = 1, run = 1;
            for (let i = 1; i < sorted.length; i++) {
                const diff = (new Date(sorted[i]) - new Date(sorted[i - 1])) / 86400000;
                if (diff === 1) { run++; if (run > best) best = run; }
                else run = 1;
            }
            return best;
        }

        function toYMD(d) {
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        const DAY_MS = 86400000;
        function msToYMD(ms) {
            const d = new Date(ms);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }
        function localMidnight() {
            const n = new Date();
            return new Date(n.getFullYear(), n.getMonth(), n.getDate()).getTime();
        }

        function calcStreak(arr) {
            if (!arr.length) return 0;
            const set = new Set(arr);
            const todayMs = localMidnight();
            let startMs = todayMs;
            if (!set.has(msToYMD(startMs))) {
                startMs -= DAY_MS;
                if (!set.has(msToYMD(startMs))) return 0;
            }
            let count = 0;
            for (let t = startMs; set.has(msToYMD(t)); t -= DAY_MS) count++;
            return count;
        }

        function buildGrid() {
            const set = new Set(dates);
            const today = new Date(); today.setHours(0,0,0,0);
            const todayStr = toYMD(today);
            const end = new Date(today);
            end.setDate(today.getDate() + (6 - today.getDay()));
            const start = new Date(end);
            start.setDate(end.getDate() - 363);
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            const cur = new Date(start);
            while (cur <= end) {
                const ymd = toYMD(cur);
                const dot = document.createElement('div');
                dot.className = 'dot';
                if (cur > today)          dot.classList.add('dot-future');
                else if (set.has(ymd))    dot.classList.add('dot-filled');
                if (ymd === todayStr)     dot.classList.add('dot-today');
                dot.title = ymd;
                grid.appendChild(dot);
                cur.setDate(cur.getDate() + 1);
            }
            requestAnimationFrame(() => { grid.scrollLeft = grid.scrollWidth; });
        }

        function renderList() {
            const list = document.getElementById('postDatesList');
            list.innerHTML = '';
            [...dates].sort().reverse().forEach(date => {
                const li  = document.createElement('li');
                const btn = document.createElement('button');
                btn.className = 'log-remove';
                btn.textContent = '×';
                btn.addEventListener('click', async () => {
                    dates = dates.filter(d => d !== date);
                    update();
                    await syncToGitHub();
                });
                li.appendChild(document.createTextNode(date));
                li.appendChild(btn);
                list.appendChild(li);
            });
        }

        function update() {
            const streak = calcStreak(dates);
            const best   = Math.max(calcBestStreak(dates), streak);
            document.getElementById('currentStreak').textContent = streak;
            document.getElementById('bestStreak').textContent = best;
            buildGrid();
            renderList();
        }

        document.getElementById('addPostBtn').addEventListener('click', async () => {
            const val = document.getElementById('postDate').value;
            if (!val) return;
            if (!dates.includes(val)) dates.push(val);
            update();
            await syncToGitHub();
        });

        document.getElementById('postDate').addEventListener('keydown', e => {
            if (e.key === 'Enter') document.getElementById('addPostBtn').click();
        });

        // ── Admin password (SHA-256 hash — plaintext never stored in source) ──
        const ADMIN_HASH = '3b4b8072bd0a4606ffd2854d373d607aedb78a8406c929783c0b1db5cec80c25';

        async function hashInput(str) {
            const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
            return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        document.querySelector('.log-section > summary').addEventListener('click', e => {
            const panel = e.currentTarget.closest('details');
            if (panel.open) return;
            e.preventDefault();
            const input = prompt('password');
            if (input === null) return;
            hashInput(input).then(hash => {
                if (hash !== ADMIN_HASH) return;
                if (!localStorage.getItem(TOKEN_KEY)) {
                    const token = prompt('GitHub token (stored on this device only):');
                    if (token) localStorage.setItem(TOKEN_KEY, token.trim());
                }
                panel.open = true;
            });
        });
        // ────────────────────────────────────────────────────────────────────

        document.getElementById('changeTokenBtn').addEventListener('click', () => {
            const token = prompt('Enter new GitHub token:');
            if (token === null) return;
            if (token.trim()) {
                localStorage.setItem(TOKEN_KEY, token.trim());
                setSyncStatus('token saved', false);
                setTimeout(() => setSyncStatus('', false), 2000);
            } else {
                localStorage.removeItem(TOKEN_KEY);
                setSyncStatus('token cleared', false);
                setTimeout(() => setSyncStatus('', false), 2000);
            }
        });

        document.getElementById('postDate').value = toYMD(new Date());
        loadDates().then(() => update());
    </script>
</body>
</html>
